---
title: "FMB819: Rì„ ì´ìš©í•œ ë°ì´í„°ë¶„ì„"
subtitle: "<span style='font-size:1.5em; color:#a01616;'>Instrumental Variables</span>"
# date: "`r Sys.Date()`"
format:
  revealjs:
    slide-number: true
    # smaller: true
    scrollable: true
    chalkboard: true
    transition: fade
    transition-speed: fast
    #incremental: true
    #lib_dir: libs
    css: [default, "../css/kubs.css", "../css/kubs-fonts.css"]
    #nature:
      # beforeInit: ["../js/ru_xaringan.js"]
      #highlightStyle: github
      #highlightLines: true
      #countIncrementalSlides: false
    #  ratio: "16:9"
    # includes:
    #   in_header: "../libs/partials/header.html"
revealjs-plugins:
  - revealjs-text-resizer    
---



```{r setup, include=FALSE,warning=FALSE,message=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  dev = "svg",
  cache = TRUE,
  fig.align = "center"
  #fig.width = 11,
  #fig.height = 5
)

# define vars
om = par("mar")
lowtop = c(om[1],om[2],0.1,om[4])
library(magrittr)
library(ggplot2)

# define vars
library(broom)
library(estimatr)
library(modelsummary)
gm = modelsummary::gof_map
gm$omit <- TRUE
gm$omit[gm$clean == "R2"] <- FALSE
gm$omit[gm$clean == "Num.Obs."] <- FALSE
gom = "p.value.|se_type|statistic.end|statistic.overid|statistic.weakinst"



library(countdown)

# countdown style
countdown(
  color_border              = "#d90502",
  color_text                = "black",
  color_running_background  = "#d90502",
  color_running_text        = "white",
  color_finished_background = "white",
  color_finished_text       = "#d90502",
  color_finished_border     = "#d90502"
)


```




------------------------------------------------------------------------

## Today's Agenda



* ë„êµ¬ë³€ìˆ˜ *instrumental variables* (IV)

* John Snow's ì—°êµ¬: 1850ë…„ ì˜êµ­ ëŸ°ë˜ ...

* IV estimatorë€?

* 2ë‹¨ê³„ ìµœì†Œì¢ŒìŠ¹ë²• (Two Stage Least Squares)

* ì•½í•œ ë„êµ¬ë³€ìˆ˜ (Weak Instruments)



---


## ë°°ê²½

:::: columns

::: {.column width="50%"}

- ì±…ì˜ [7ì¥](https://scpoecon.github.io/ScPoEconometrics/causality.html), [8ì¥](https://scpoecon.github.io/ScPoEconometrics/STAR.html), [9ì¥](https://scpoecon.github.io/ScPoEconometrics/RDD.html) ë° ì…ë¬¸ ê³¼ì •ì—ì„œ **ì‹¤í—˜ì  ë°©ë²•(experimental methods)**ì˜ ì¥ì ì— ëŒ€í•´ ë…¼ì˜í•¨.

- ë¬´ì‘ìœ„ ëŒ€ì¡° ì‹¤í—˜(Randomized Control Trials, RCT) ë˜ëŠ” **ì¤€ì‹¤í—˜ì (Quasi-experimental) ë°©ë²•**(ë¬´ì‘ìœ„ í• ë‹¹ê³¼ ìœ ì‚¬í•œ ìƒí™©)ì€ **ì¸ê³¼ íš¨ê³¼(causal effects)**ë¥¼ ì¶”ì •í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤Œ.

- íŠ¹íˆ, [RCT](https://scpoecon.github.io/ScPoEconometrics/causality.html#rct)ì— ëŒ€í•´ ì´ë¯¸ ìµìˆ™í•  ê²ƒì„.

:::

::: {.column width="50%"}

- ë§Œì•½ ê°œì¸ì´ ì²˜ì¹˜ë¥¼ ë°›ì„ì§€ ì—¬ë¶€ë¥¼ **í†µì œí•  ìˆ˜ ìˆë‹¤ë©´**, *ì„ íƒ í¸í–¥(selection bias)*ì´ ë°œìƒí•  ìˆ˜ ìˆìŒ.

- RCTëŠ” ë¬´ì‘ìœ„ í• ë‹¹ì„ í†µí•´ **ìê°€ ì„ íƒ(self-selection)** ë¬¸ì œë¥¼ í•´ê²°í•¨.

- ë”°ë¼ì„œ **ì‹¤í—˜ ë°ì´í„°**ê°€ ìˆë‹¤ë©´ ì¢‹ì€ í•´ê²°ì±…ì´ ì¡´ì¬í•¨.

- ê·¸ë ‡ë‹¤ë©´ **ë¹„ì‹¤í—˜ ë°ì´í„°(non-experimental data)**ëŠ” ì–´ë–»ê²Œ ë¶„ì„í•´ì•¼ í• ê¹Œ?

:::

::::


---



## ë¹„ì‹¤í—˜ ë°ì´í„° (Non-Experimental Data)

:::: columns

::: {.column width="50%"}

- **ëˆ„ë½ëœ ë³€ìˆ˜ í¸í–¥(omitted variable bias)**ì— ëŒ€í•´ ë…¼ì˜í•œ ë°” ìˆìŒ.

- ì˜¤ì°¨í•­ $u$ì— í¬í•¨ëœ ë³€ìˆ˜ $x_2$ì™€ ì„¤ëª… ë³€ìˆ˜ $x_1$ ì‚¬ì´ì— ìƒê´€ê´€ê³„ê°€ ì¡´ì¬í•œë‹¤ë©´ ì–´ë–»ê²Œ ë ê¹Œ?

- ìš°ë¦¬ëŠ” $x_1$ì˜ íš¨ê³¼ì™€ $x_2$ì˜ íš¨ê³¼ë¥¼ ë¶„ë¦¬í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— **í¸í–¥ëœ ì¶”ì •ì¹˜**ë¥¼ ì–»ê²Œ ë¨.

- ì´ëŸ¬í•œ í¸í–¥ì´ ë„ˆë¬´ ì‹¬í•˜ë©´ **íš¨ê³¼ì˜ ë°©í–¥(ë¶€í˜¸)ì¡°ì°¨ ì˜ëª» ì¶”ì •í•  ìˆ˜ ìˆìŒ**.

:::

::: {.column width="50%"}

```{r dag1,fig.height = 6,echo = FALSE}
library(ggdag)
library(dplyr)
dag = dagify(y ~ x1,
            y ~ x2,
            y ~ x3,
            x1 ~ x2,
            x3 ~ x2,
       coords = list(x = c("x2" = 0,"x1" = 1,"x3" = 1.0,"y" = 2),
                     y = c("x2" = 0,"x1" = 0.5,"x3" = -0.5,"y" = 0)))
p2 = dag %>%
  tidy_dagitty() %>%
      mutate(linetype = if_else(name =="x2", "dashed","solid")) %>% 
    ggplot(aes(x = x, y = y, xend = xend, yend = yend)) + 
    geom_dag_point() + 
      geom_dag_text(col = "white") +
    geom_dag_edges(aes(edge_linetype = linetype), show.legend = FALSE) + theme_dag()
p2
```

:::

::::


- **IV** ëŠ” OVBë¡œ ì¸í•œ ë¬¸ì œë¥¼ í•´ê²°í•œë‹¤.



## [1850ë…„ ëŸ°ë˜: ì¼„ì‹±í„´ì˜ ë¹ˆë¯¼ê°€]{style="color:white;"}{background-image="../img/photos/Kensington_slums_large.jpg"}



---


## ì¡´ ìŠ¤ë…¸ìš°ì˜ (ë¹„)ì‹¤í—˜: ì½œë ˆë¼ê°€ ë„ì‹œë¥¼ ê°•íƒ€

:::: columns

::: {.column width="50%"}

- ì¡´ ìŠ¤ë…¸ìš°(John Snow)ëŠ” 1850ë…„ê²½ ëŸ°ë˜ì—ì„œ í™œë™í•œ ì˜ì‚¬ë¡œ, ê·¸ ë‹¹ì‹œ ë„ì‹œì—ì„œëŠ” **ì½œë ˆë¼ê°€ ì—¬ëŸ¬ ì°¨ë¡€ ì°½ê¶**í•˜ì˜€ìŒ.

- ë‹¹ì‹œ **ì§ˆë³‘ì˜ ì „íŒŒ ë°©ì‹**ì— ëŒ€í•œ ë…¼ìŸì´ ìˆì—ˆìŒ: ê³µê¸°ë¥¼ í†µí•´ ì „ì—¼ë˜ëŠ”ê°€, ì•„ë‹ˆë©´ ë¬¼ì„ í†µí•´ ì „ì—¼ë˜ëŠ”ê°€?

:::

::: {.column width="50%"}

```{r, fig.width=6, echo = FALSE}
knitr::include_graphics("../img/photos/father-thames.jpg")
```

:::

::::

---

## {background-image="../img/photos/slum.jpg"}

---


## [1850ë…„ì˜ ì˜ë£Œ ì§€ì‹]{style="color:white;"} {background-image="../img/photos/slum.jpg"}

[ì„¸ê· ì´ ì§ˆë³‘ì„ ìœ ë°œí•  ìˆ˜ ìˆë‹¤ëŠ” ì‚¬ì‹¤ì´ ì•Œë ¤ì§€ì§€ ì•ŠìŒ.]{style="color:white;"}

[í˜„ë¯¸ê²½ì€ ì¡´ì¬í–ˆì§€ë§Œ, í•´ìƒë„ê°€ ë‚®ì•„ ë³‘ì›ê· ì„ ëª…í™•íˆ ë³¼ ìˆ˜ ì—†ì—ˆìŒ.]{style="color:white;"}

[ëŒ€ë¶€ë¶„ì˜ ì¸ê°„ ë³‘ì›ê· ì€ ìœ¡ì•ˆìœ¼ë¡œ ê´€ì°°í•  ìˆ˜ ì—†ìŒ.]{style="color:white;"}

[ì´ë¥¸ë°” 'ê°ì—¼ ì´ë¡ '(ì¦‰, *ì„¸ê· *ì— ì˜í•œ ê°ì—¼)ì´ ì¼ë¶€ ì§€ì§€ë¥¼ ë°›ì•˜ìœ¼ë‚˜,]{style="color:white;"}

[ë‹¹ì‹œì˜ ì§€ë°°ì ì¸ ì´ë¡ ì€ ì§ˆë³‘ì´ [ë¯¸ì•„ìŠ¤ë§ˆ](https://en.wikipedia.org/wiki/Miasma_theory)ì— ì˜í•´ ë°œìƒí•œë‹¤ëŠ” ê²ƒì´ì—ˆìŒ.]{style="color:white;"}



---

## ìŠ¤ë…¸ìš°ì˜ íƒì • í™œë™

:::: columns

::: {.column width="50%"}

- ìŠ¤ë…¸ìš°ëŠ” ë°©ëŒ€í•œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ì˜€ìŒ.

- 1854ë…„ ë°œìƒí•œ ì½œë ˆë¼ ìœ í–‰ ì‹œ **ì‚¬ë§ìì˜ ìœ„ì¹˜ë¥¼ ì§€ë„ì— í‘œì‹œ**í•˜ì˜€ìŒ.

- ì´ ì‚¬ê±´ì´ ë°”ë¡œ ì•…ëª… ë†’ì€ **ë¸Œë¡œë“œìŠ¤íŠ¸ë¦¬íŠ¸ íŒí”„(Broadstreet Pump) ì‚¬ê±´**ì„.

:::

::: {.column width="50%"}

```{r snow-map, echo = FALSE}
knitr::include_graphics("../img/photos/snow-map.jpg")
```

:::

::::

---

## `cholera` íŒ¨í‚¤ì§€

:::: columns

::: {.column width="50%"}

- `cholera` íŒ¨í‚¤ì§€ëŠ” ì¡´ ìŠ¤ë…¸ìš°ì˜ ì—°êµ¬ë¥¼ ì¬í˜„í•˜ëŠ” í¥ë¯¸ë¡œìš´ ê¸°ëŠ¥ì„ í¬í•¨í•˜ê³  ìˆìŒ.

- ì˜ˆë¥¼ ë“¤ì–´, **ìŠ¤ë…¸ìš°ì˜ ì§€ë„(R ë²„ì „)**ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŒ:

:::

::: {.column width="50%"}

```{r, echo=T}
cholera::snowMap()
```

:::

::::

---

## `cholera` íŒ¨í‚¤ì§€ì˜ ê¸°ëŠ¥

:::: columns

::: {.column width="50%"}

- ë˜ëŠ” **ì‚¬ë¡€ ë²ˆí˜¸ 15ë²ˆ í™˜ìì˜ ì´ë™ ê²½ë¡œ**ë¥¼ ì‹œê°í™”í•  ìˆ˜ë„ ìˆìŒ:

```{r, echo = FALSE, fig.height = 5}
plot(cholera::walkingPath(15))
```

:::

::: {.column width="50%"}

- í˜¹ì€ **íŒí”„ ì£¼ë³€ ì§€ì—­ì˜ ë³´ë¡œë…¸ì´ ë‹¤ê°í˜•(Voronoi polygons)**ì„ ì¶”ì •í•  ìˆ˜ë„ ìˆìŒ:

```{r, echo = FALSE, fig.height = 5}
# ë³´ë¡œë…¸ì´ ë‹¤ê°í˜•ì˜ ê¼­ì§“ì  ê³„ì‚°
vertices <- cholera::voronoiPolygons(sites = cholera::pumps, rw.data = cholera::roads)

# ìƒ‰ìƒ ì •ì˜
snow.colors <- grDevices::adjustcolor(cholera::snowColors(), alpha.f = 1/3)

# ì§€ë„ ë° ìƒ‰ìƒ íƒ€ì¼ í‘œì‹œ
cholera::snowMap(add.cases = FALSE)
invisible(lapply(seq_along(vertices), function(i) {
  polygon(vertices[[i]], col = snow.colors[[i]])
}))
```

:::

::::

---


## ë¸Œë¡œë“œ ìŠ¤íŠ¸ë¦¬íŠ¸ íŒí”„ì˜ ì œê±°?

:::: columns

::: {.column width="50%"}

- ìŠ¤ë…¸ìš°ëŠ” **ë¸Œë¡œë“œ ìŠ¤íŠ¸ë¦¬íŠ¸ íŒí”„(Broad Street Pump)**ê°€ ì›ì¸ì´ë¼ê³  ì§€ëª©í•¨.

- ê·¸ëŠ” **íŒí”„ ì†ì¡ì´ë¥¼ ì œê±°í•  ê²ƒì„ ìš”ì²­**í•˜ì˜€ìŒ.

- í•˜ì§€ë§Œ, ê·¸ëŠ” ì´ ì¡°ì¹˜ê°€ **ìœ í–‰ë³‘ì˜ ì¢…ì‹ì„ ê°€ì ¸ì™”ë‹¤ëŠ” ì ì— íšŒì˜ì ì´ì—ˆìŒ**.

:::

::: {.column width="50%"}

```{r, echo = FALSE}
plot(cholera::timeSeries())
```

:::

::::

---

## ëŸ°ë˜ì˜ ìƒìˆ˜ë„ ê³µê¸‰ ì§€ë„

- ëŸ°ë˜ì˜ **ìƒìˆ˜ë„ ê³µê¸‰ì›ì€ í…œìŠ¤ê°•(River Thames)ì´ì—ˆìŒ.**

- ê° ìƒìˆ˜ë„ íšŒì‚¬ëŠ” **ë‹¤ë¥¸ ì·¨ìˆ˜ ì§€ì (intake points)**ì„ ê°€ì¡ŒìŒ.

- **ì‚¬ìš°ìŠ¤ì›Œí¬(Southwark) ë° ë³µìŠ¤í™€(Vauxhall) ìˆ˜ìì› íšŒì‚¬**ëŠ” ëŒ€í˜• í•˜ìˆ˜ ë°°ì¶œêµ¬ ì•„ë˜ì—ì„œ ì·¨ìˆ˜ë¥¼ í•˜ì˜€ìŒ.

- **ë¨ë²„ìŠ¤(Lambeth) ìˆ˜ìì› íšŒì‚¬**ëŠ” ë” ê¹¨ë—í•œ ìƒë¥˜ì—ì„œ ì·¨ìˆ˜ë¥¼ í•˜ì˜€ìŒ.

---

## ìŠ¤ë…¸ìš°ì˜ ê²°ë¡ 

- ìŠ¤ë…¸ìš°ê°€ ìˆ˜ì§‘í•œ ë°ì´í„°ëŠ” ë‹¤ìŒê³¼ ê°™ìŒ:

```{r, echo = FALSE}
st9 <- data.frame(area = c("Southwark and Vauxhall","Lambeth","Rest of London"),
                  numhouses = c(40046,26107,256423), 
                  deaths = c(1263,98,1422),
                  death1000 = c(315,37,59))
knitr::kable(st9)
```

- ê·¸ë¦¬ê³  ë‹¤ìŒê³¼ ê°™ì€ ê²°ë¡ ì„ ë‚´ë¦¼:

> ë§Œì•½ **ì‚¬ìš°ìŠ¤ì›Œí¬ ë° ë³µìŠ¤í™€ ìˆ˜ìì› íšŒì‚¬ê°€ ì·¨ìˆ˜ ì§€ì ì„ ìƒë¥˜ë¡œ ì˜®ê²¨** ë¨ë²„ìŠ¤ ìˆ˜ìì› íšŒì‚¬ì™€ ê°™ì€ ê³³ì—ì„œ ë¬¼ì„ ê³µê¸‰ë°›ì•˜ë‹¤ë©´, **ì•½ 1,000ëª…ì˜ ëª©ìˆ¨ì„ êµ¬í•  ìˆ˜ ìˆì—ˆì„ ê²ƒ**ì´ë‹¤.

- í•˜ì§€ë§Œ **ë¯¸ì•„ìŠ¤ë§ˆ ì´ë¡ ì˜ ì§€ì§€ìë“¤**ì€ ì—¬ì „íˆ ì´ë¥¼ ê²°ì •ì ì¸ ì¦ê±°ë¡œ ë°›ì•„ë“¤ì´ì§€ ì•Šì•˜ìŒ. ì™œëƒí•˜ë©´ **ì´ ì§€ì—­ì˜ ë‚˜ìœ ê³µê¸°ì§ˆì„ ìœ ë°œí•˜ëŠ” ë‹¤ë¥¸ ìš”ì¸ë“¤ë„ ì¡´ì¬í–ˆê¸° ë•Œë¬¸**ì„.




# We Need A Model.


---

## ìŠ¤ë…¸ìš°ì˜ ì½œë ˆë¼ ì „íŒŒ ëª¨ë¸

- ê°œì¸ $i$ê°€ ì½œë ˆë¼ë¡œ ì‚¬ë§í•˜ë©´ $c_i = 1$, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ $c_i = 0$ë¡œ ì •ì˜í•¨.

- $w_i = 1$ì€ $i$ì˜ ì‹ìˆ˜ê°€ **ì˜¤ì—¼ë˜ì—ˆìŒì„ ì˜ë¯¸**í•˜ë©°, $w_i = 0$ì€ ê¹¨ë—í•œ ë¬¼ì„ ì˜ë¯¸í•¨. 

- ë‹¹ì‹œ ê¸°ìˆ ë¡œëŠ” ì‘ì€ ë¯¸ìƒë¬¼ì„ ê°ì§€í•  ìˆ˜ ì—†ì—ˆìŒ.

- $u_i$ëŠ” ê°œì¸ $i$ì˜ ì‚¬ë§ í™•ë¥ ì— ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” **ê´€ì¸¡ë˜ì§€ ì•ŠëŠ” ìš”ì¸**(ì˜ˆ: ê°€ë‚œ, ê±°ì£¼ ìœ„ì¹˜, ê³µê¸°ì§ˆ, ìœ ì „ì  íŠ¹ì„± ë“±)ì„ í¬í•¨í•¨.

ìš°ë¦¬ëŠ” ì´ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì‹í™”í•  ìˆ˜ ìˆìŒ:

$$
c_i = \alpha + \delta w_i + u_i 
$$

---

## ë‹¨ìˆœí•œ ë¶„ì„ì´ í•­ìƒ ì˜³ì€ê°€?

:::: columns
::: {.column width="50%"}
- ìŠ¤ë…¸ìš°ëŠ” ìì‹ ì˜ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ **ê¹¨ë—í•œ ë¬¼ì„ ë§ˆì‹œëŠ” ê²ƒê³¼ ì½œë ˆë¼ ë°œìƒë¥  ê°„ì˜ ìƒê´€ê´€ê³„**ë¥¼ í‰ê°€í•  ìˆ˜ë„ ìˆì—ˆìŒ.

- ì¦‰, $Cor(c_i, w_i)$ë¥¼ ì¸¡ì •í•  ìˆ˜ ìˆìŒ.

- ë§Œì•½ $Cor(c_i, w_i) \approx 0.5$ë¼ë©´, ì´ëŠ” ê°ì—¼ ì´ë¡ ì„ ì¦ëª…í•˜ëŠ”ê°€?
:::

::: {.column width="50%"}

> ê²½ì œí•™ì **ì•µê±°ìŠ¤ ë””í„´(Angus Deaton)**ì€ ë‹¤ìŒê³¼ ê°™ì´ ì§€ì í•¨:
>
> "ì˜¤ì—¼ëœ ë¬¼ì„ ë§ˆì‹  ì‚¬ëŒë“¤ì€ ê°€ë‚œí•  ê°€ëŠ¥ì„±ì´ ë” ë†’ê³ , ë‹¤ì–‘í•œ ë°©ì‹ìœ¼ë¡œ ì˜¤ì—¼ëœ í™˜ê²½ì— ì‚´ê³  ìˆì—ˆìœ¼ë©°, ë‹¹ì‹œ ì½œë ˆë¼ì˜ ì›ì¸ìœ¼ë¡œ ì—¬ê²¨ì¡Œë˜ â€˜ìœ ë…í•œ ë¯¸ì•„ìŠ¤ë§ˆâ€™ì— ë” ë§ì´ ë…¸ì¶œë˜ì—ˆìŒ."

â˜¹ï¸ ë‹¨ìˆœí•œ ìƒê´€ê´€ê³„ë¡œëŠ” ì¶©ë¶„í•˜ì§€ ì•ŠìŒ!
:::
::::


---

## ë‹¨ìˆœ ë¹„êµì˜ ë¬¸ì œì 

- ê¹¨ë—í•œ ë¬¼ì„ ë§ˆì‹œëŠ” ì‚¬ëŒê³¼ ì˜¤ì—¼ëœ ë¬¼ì„ ë§ˆì‹œëŠ” ì‚¬ëŒì„ **ë‹¨ìˆœ ë¹„êµí•˜ëŠ” ê²ƒì€ ì˜ë¯¸ê°€ ì—†ìŒ.**

- **ì™œëƒí•˜ë©´ ëª¨ë“  ì¡°ê±´ì´ ë™ì¼í•˜ì§€ ì•Šê¸° ë•Œë¬¸**($all\ else\ is\ not\ equal$). ê¹¨ë—í•œ ë¬¼ì„ ë§ˆì‹œëŠ” ê²ƒê³¼ ê°€ë‚œ, ì—´ì•…í•œ ê±°ì£¼ í™˜ê²½, ë‚˜ìœ ê³µê¸°ì§ˆ ë“±ì´ **ë°€ì ‘í•œ ê´€ë ¨**ì´ ìˆìŒ. 

- ì´ëŠ” OLS ì¶”ì •ì„ ìœ„í•œ **í•„ìˆ˜ì ì¸ ì§êµì„±(orthogonality) ê°€ì •**ì„ ìœ„ë°˜í•¨:

  $$E[u_i | w_i] \neq 0$$

- ë˜ ë‹¤ë¥¸ í‘œí˜„ìœ¼ë¡œ, **$Cov(w_i, u_i) \neq 0$** ì¦‰, $w_i$ëŠ” **ë‚´ìƒì (endogenous)** ë³€ìˆ˜ì„.

- ì¦‰, $u_i$ì— í¬í•¨ëœ ìš”ì†Œë“¤ì´ $w_i$ì™€ $c_i$ ëª¨ë‘ì— ì˜í–¥ì„ ë¯¸ì¹¨.

---

## ìŠ¤ë…¸ìš°ì˜ ëª¨ë¸ê³¼ ëŒ€ìˆ˜ì  ì ‘ê·¼

ë‹¨ìˆœí•œ ëª¨ë¸ì„ ë‹¤ì‹œ ë– ì˜¬ë ¤ ë³´ì:

$$c_i = \alpha + \delta w_i + u_i$$

ì´ì œ $w$ì˜ ë‘ ê°€ì§€ ê°’ì— ë”°ë¼ ê¸°ëŒ€ê°’ì„ ê³„ì‚°í•˜ë©´,

\begin{align}
E[c_i | w_i = 1] &= \alpha + \delta + E[u_i | w_i = 1] \\
E[c_i | w_i = 0] &= \alpha + \phantom{\delta} + E[u_i | w_i = 0]
\end{align}

ì´ ë‘ ì‹ì„ ë¹¼ë©´,

\begin{equation}
E[c_i | w_i = 1] - E[c_i | w_i = 0] = \delta + \left\{ E[u_i | w_i = 1] - E[u_i | w_i = 0]\right\}
\end{equation}

- ë§ˆì§€ë§‰ í•­ \( \left\{ E[u_i | w_i = 1] - E[u_i | w_i = 0]\right\} \) ì€ **0ì´ ì•„ë‹˜** (ë””í„´ì´ ë§í•œ ê²ƒì²˜ëŸ¼!).

- ì¦‰, **íšŒê·€ ë¶„ì„ì„ í†µí•œ $\delta$ ì¶”ì •ì¹˜ëŠ” í¸í–¥ë¨(biased).**




# The IV Estimator


---

## ì¡´ ìŠ¤ë…¸ìš° ì™ˆ

> "... ë¬¼ ê³µê¸‰ì´ ì•„ì£¼ ë³µì¡í•˜ê²Œ ì„ì—¬ìˆë‹¤. ê° íšŒì‚¬ì˜ ìˆ˜ë„ê´€ì€ ëª¨ë“  ê±°ë¦¬ì™€ ê±°ì˜ ëª¨ë“  ê³¨ëª©ê¸¸ê³¼ í›„ë¯¸ì§„ ê³³ê¹Œì§€ ì´ì–´ì§„ë‹¤. ...
>
> ì´ ì‹¤í—˜ì€ ë§¤ìš° ê±°ëŒ€í•œ ê·œëª¨ì—ì„œ ì§„í–‰ë˜ì—ˆë‹¤. ë¬´ë ¤ 30ë§Œ ëª…ì´ ë„˜ëŠ” ì‚¬ëŒë“¤ì´ ì„±ë³„, ì—°ë ¹, ì§ì—…, ì‚¬íšŒì  ê³„ì¸µê³¼ ìƒê´€ì—†ì´ ë‘ ê°œì˜ ê·¸ë£¹ìœ¼ë¡œ ë‚˜ë‰˜ì—ˆë‹¤. 
>
> í•œ ê·¸ë£¹ì€ ëŸ°ë˜ì˜ í•˜ìˆ˜ë¥¼ í¬í•¨í•˜ì—¬ ì½œë ˆë¼ í™˜ìë“¤ë¡œë¶€í„° ë‚˜ì˜¨ ëª¨ë“  ì˜¤ì—¼ë¬¼ì„ í¬í•¨í•  ê°€ëŠ¥ì„±ì´ ìˆëŠ” ë¬¼ì„ ê³µê¸‰ë°›ì•˜ìœ¼ë©°, 
>
> ë‹¤ë¥¸ ê·¸ë£¹ì€ ê·¸ëŸ° ì˜¤ì—¼ë¬¼ë¡œë¶€í„° ì™„ì „íˆ ììœ ë¡œìš´ ë¬¼ì„ ê³µê¸‰ë°›ì•˜ë‹¤."




---

## [London Water Supply]{style="color:white;"}{background-image="../img/photos/snow-supply.jpg"}



---

## ë„êµ¬ë³€ìˆ˜(IV) ì œì•ˆ

- ìŠ¤ë…¸ìš°ëŠ” **ë„êµ¬ë³€ìˆ˜(instrumental variable, IV)** $z_i$ë¥¼ ì œì•ˆí•¨. ì´ëŠ” ê°€êµ¬ $i$ì— ë¬¼ì„ ê³µê¸‰í•˜ëŠ” **ìˆ˜ë„ íšŒì‚¬ì˜ ì •ì²´ì„±**ì„.

ë” í˜•ì‹ì ìœ¼ë¡œ, ë„êµ¬ë³€ìˆ˜ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ì •ì˜í•  ìˆ˜ ìˆìŒ:

\begin{align*}
z_i &=  \begin{cases}
                    1 & \text{if ë¬¼ ê³µê¸‰ìê°€ Lambethì¼ ê²½ìš°} \\
                    0 & \text{if ë¬¼ ê³µê¸‰ìê°€ Southwark ë˜ëŠ” Vauxhallì¼ ê²½ìš°} \\
                 \end{cases} \\
\end{align*}

- $z_i$ëŠ” **ì‹ìˆ˜ì˜ ìˆœë„** $w_i$ì™€ ë†’ì€ ìƒê´€ê´€ê³„ë¥¼ ê°€ì§.

- í•˜ì§€ë§Œ, $z_i$ëŠ” ìš°ë¦¬ê°€ ì´ì „ì— ìš°ë ¤í–ˆë˜ **$u_i$ ë‚´ì˜ ë‹¤ë¥¸ ëª¨ë“  ìš”ì¸ë“¤ê³¼ëŠ” ìƒê´€ê´€ê³„ê°€ ì—†ì–´ ë³´ì„**. 

  - ë¬¼ ê³µê¸‰ì€ **ìˆ˜ë…„ ì „ì— ê²°ì •**ë˜ì—ˆìœ¼ë©°,
  - ê°™ì€ ê±°ë¦¬ ë‚´ì˜ ì§‘ë“¤ë„ **ì„œë¡œ ë‹¤ë¥¸ ìˆ˜ë„ ê³µê¸‰ìë¥¼ ê°€ì§ˆ ìˆ˜ ìˆì—ˆìŒ**.

---

## [Simple IV in a DAG]{style="color:black;"}{background-image="../img/photos/IV-dag.png"}


* $u$ëŠ” ë…ë¦½ë³€ìˆ˜ì™€ ê²°ê³¼ ëª¨ë‘ ì˜í–¥ì„ ë¯¸ì¹¨

```{r IV-dag, warning = FALSE, eval = FALSE, message = FALSE, echo = FALSE, fig.width = 3.5, fig.height = 1.5}
library(ggdag)
library(dplyr)

# ì¢Œí‘œ ì„¤ì •
coords <- list(
    x = c(z = 1, w = 3, u = 4, c = 5),
    y = c(z = 0, w = 0, u = 0.5, c = 0)
)

# DAG ì •ì˜
dag <- dagify(c ~ w + u,
              w ~ z + u, coords = coords)

# DAG ì‹œê°í™”
dag %>% 
  tidy_dagitty() %>% 
  mutate(linetype = ifelse(name == "u", "dashed", "solid")) %>% 
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) + 
  geom_dag_point(size = 3) +  # ë…¸ë“œ í¬ê¸° ì¶•ì†Œ
  geom_dag_text(size = 3) +   # í…ìŠ¤íŠ¸ í¬ê¸° ì¶•ì†Œ
  geom_dag_edges(aes(edge_linetype = linetype), show.legend = FALSE) + 
  theme_void(base_size = 10)  # ê¸°ë³¸ í°íŠ¸ í¬ê¸° ì¶•ì†Œ
```




---


## IV ì¶”ì •ëŸ‰ì˜ ì •ì˜

ì´ì œ ë‹¨ìˆœí•œ **IV ì¶”ì •ëŸ‰**ì„ ì •ì˜í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŒ.

ê¸°ì¡´ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ, $z$ì˜ ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ì¡°ê±´ë¶€ ê¸°ëŒ€ê°’ì„ ê³„ì‚°í•´ë³´ì:

\begin{align}
E[c_i | z_i = 1] &= \alpha + \delta E[w_i | z_i = 1] + E[u_i | z_i = 1] \\
E[c_i | z_i = 0] &= \alpha + \delta E[w_i | z_i = 0] + E[u_i | z_i = 0]
\end{align}

ì´ ë‘ ì‹ì„ ë¹¼ë©´:

\begin{align}
E[c_i | z_i = 1] - E[c_i | z_i = 0] &= \delta  \left\{ E[w_i | z_i = 1] - E[w_i | z_i = 0]\right\} \\
&+ \underbrace{\left\{ E[u_i | z_i = 1] - E[u_i | z_i = 0] \right\}}_{=0 \text{ (ë…ë¦½ì„± ê°€ì •ì— ì˜í•´)}}
\end{align}

---

## ìµœì¢… IV ì¶”ì •ëŸ‰

- ë§ˆì§€ë§‰ìœ¼ë¡œ, **IVê°€ ìœ íš¨í•˜ë‹¤ë©´** (ì¦‰, $E[w_i | z_i = 1] - E[w_i | z_i = 0] \neq 0$):

\begin{equation}
\delta = \frac{E[c_i | z_i = 1] - E[c_i | z_i = 0]}{E[w_i | z_i = 1] - E[w_i | z_i = 0]} \tag{eq:IV}
\end{equation}

ì¦‰, IV ì¶”ì •ëŸ‰ì€ ê²°ê³¼ ë³€ìˆ˜($c$)ì˜ ë³€í™”ëŸ‰ì„ ë„êµ¬ë³€ìˆ˜($z$)ê°€ ìœ ë°œí•˜ëŠ” ì„¤ëª… ë³€ìˆ˜($w$)ì˜ ë³€í™”ëŸ‰ìœ¼ë¡œ ë‚˜ëˆˆ ê°’ì„.

---


## íŠ¹ìˆ˜í•œ ê²½ìš°: ì›”ë“œ(Wald) ì¶”ì •ëŸ‰

$x \mapsto y$ëŠ” $x$ê°€ $y$ì˜ ì¶”ì •ì¹˜ì„ì„ ì˜ë¯¸í•œë‹¤ê³  í•˜ì:

1. $\overline{c}_1 \mapsto E[c_i | z_i = 1]$: Lambethì—ì„œ ê³µê¸‰ë°›ì€ ê°€êµ¬ ì¤‘ ì½œë ˆë¼ì— ê±¸ë¦° ë¹„ìœ¨.
2. $\overline{w}_1 \mapsto E[w_i | z_i = 1]$: Lambethì—ì„œ ê³µê¸‰ë°›ì€ ê°€êµ¬ ì¤‘ ì˜¤ì—¼ëœ ë¬¼ì„ ê³µê¸‰ë°›ì€ ë¹„ìœ¨.
3. $\overline{c}_0 \mapsto E[c_i | z_i = 0]$: Lambeth ì™¸ ì§€ì—­ì—ì„œ ê³µê¸‰ë°›ì€ ê°€êµ¬ ì¤‘ ì½œë ˆë¼ì— ê±¸ë¦° ë¹„ìœ¨.
4. $\overline{w}_0 \mapsto E[w_i | z_i = 0]$: Lambeth ì™¸ ì§€ì—­ì—ì„œ ê³µê¸‰ë°›ì€ ê°€êµ¬ ì¤‘ ì˜¤ì—¼ëœ ë¬¼ì„ ê³µê¸‰ë°›ì€ ë¹„ìœ¨.

ì´ ê²½ìš° ì¶”ì •ëŸ‰ì€ ë‹¤ìŒê³¼ ê°™ìŒ:

\begin{equation}
\hat{\delta} = \frac{\overline{c}_1 - \overline{c}_0}{\overline{w}_1 - \overline{w}_0} 
\end{equation}

ìœ„ì˜ ëª¨ë“  ë³€ìˆ˜ $c, w, z$ê°€ **ì´ì§„(binary) ë³€ìˆ˜**ì¸ ê²½ìš°, ì´ ì¶”ì •ëŸ‰ì€ *ì›”ë“œ(Wald) ì¶”ì •ëŸ‰*ì´ë¼ ë¶ˆë¦¼.

---

## ìš”ì•½

ë„êµ¬ë³€ìˆ˜(IV)ëŠ” **ê´€ì°° ë°ì´í„°ë§Œ ìˆëŠ” ìƒí™©ì—ì„œ ì¸ê³¼ ê´€ê³„ë¥¼ ì‹ë³„í•  ìˆ˜ ìˆëŠ” ê°•ë ¥í•œ ë„êµ¬**ì„. íŠ¹íˆ, ì¡°ê±´ë¶€ í‰ê·  ê°€ì •($E[u_i | x_i] = 0$)ì´ ìœ„ë°°ë  ê°€ëŠ¥ì„±ì´ ìˆëŠ” ê²½ìš°, **ì¦‰, $x$ê°€ ë‚´ìƒì (endogenous)ì¼ ë•Œ**, ì´ë¥¼ í•´ê²°í•  ìˆ˜ ìˆìŒ.

IV $z$ì˜ í•µì‹¬ ì¡°ê±´ì€ ë‹¤ìŒê³¼ ê°™ìŒ:

1. **$z$ê°€ $x$ì— ëŒ€í•´ ê´€ë ¨ì„±(relevance)ì„ ê°€ì ¸ì•¼ í•¨.**
   - ì˜ˆë¥¼ ë“¤ì–´, $z$ë¥¼ $x$ì— ëŒ€í•œ ë‹¨ìˆœ íšŒê·€ ë¶„ì„ì— ì‚¬ìš©í–ˆì„ ë•Œ ì˜ˆì¸¡ë ¥ì´ ë†’ì•„ì•¼ í•¨.
   - ë°ì´í„°ì—ì„œ *ê²€ì¦ ê°€ëŠ¥í•œ* ì¡°ê±´ì„.

2. **$z$ê°€ ê²°ê³¼ ë³€ìˆ˜ì— ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ë‹¤ë¥¸ ìš”ì¸ë“¤ê³¼ ë¬´ê´€í•˜ë‹¤ëŠ” ì´ë¡ ì  ê·¼ê±°ê°€ í•„ìš”í•¨.**
   - ì¦‰, $z$ëŠ” *ì™¸ìƒì (exogenous)*ì´ì–´ì•¼ í•˜ë©°, $E[u | z] = 0$ì´ ì„±ë¦½í•´ì•¼ í•¨.
   - ì´ëŠ” **ê°€ì •(assumption)**ì´ë¯€ë¡œ, ë°ì´í„°ë¡œ ì§ì ‘ ê²€ì¦í•  ìˆ˜ ì—†ìŒ.

---


## íŒ¨í‚¤ì§€ ì†Œê°œ [`Rayshader`](https://www.rayshader.com)

* ëª¨ë“  ì¢…ë¥˜ì˜ elevation ë°ì´í„°ë¥¼ `raytracing`í•  ìˆ˜ ìˆìŒ.
* ëŒ€ë¶€ë¶„ì˜ ggplot ê·¸ë˜í”„ë¥¼ 3Dë¡œ ë³€í™˜í•  ìˆ˜ë„ ìˆìŒ!


<video width="100%" height="50%" controls id="my_video">
    <source src="https://www.tylermw.com/wp-content/uploads/2019/05/deathappended2.mp4" type="video/mp4">
</video>

---

## íŒ¨í‚¤ì§€ ì†Œê°œ [`Rayshader`](https://www.rayshader.com)

* ì´ë ‡ê²Œë§Œ í•˜ë©´ ë¨

```{r,eval = FALSE,echo = TRUE}
library(ggplot2)
library(rayshader)
#Data from Social Security administration
death = read_csv("https://www.tylermw.com/data/death.csv", skip = 1)
meltdeath = reshape2::melt(death, id.vars = "Year")

meltdeath$age = as.numeric(meltdeath$variable)

# make a ggplot
deathgg = ggplot(meltdeath) +
  geom_raster(aes(x=Year,y=age,fill=value)) +
  scale_x_continuous("Year",expand=c(0,0),breaks=seq(1900,2010,10)) +
  scale_y_continuous("Age",expand=c(0,0),breaks=seq(0,100,10),limits=c(0,100)) +
  scale_fill_viridis("Death\nProbability\nPer Year",
       trans = "log10",breaks=c(1,0.1,0.01,0.001,0.0001), 
       labels = c("1","1/10","1/100","1/1000","1/10000")) +
  ggtitle("Death Probability vs Age and Year for the USA") +
  labs(caption = "Data Source: US Dept. of Social Security")

# give it to rayshader
plot_gg(deathgg, multicore=TRUE,height=5,width=6,scale=500)
```


---


## êµìœ¡ê³¼ ìˆ˜ì…ì˜ ê´€ê³„

***í•™êµ êµìœ¡ì´ ìˆ˜ì…ì— ë¯¸ì¹˜ëŠ” ì˜í–¥***

::: {.columns}
:::: {.column width="50%"}
- í•™êµ êµìœ¡ì´ ìˆ˜ì…ì— ë¯¸ì¹˜ëŠ” ì¸ê³¼ì  ì˜í–¥ì€ ë¬´ì—‡ì¼ê¹Œ?
- [ì œì´ì½¥ ë¯¼ì„œ(Jacob Mincer)](https://en.wikipedia.org/wiki/Jacob_Mincer)ëŠ” ì´ ì¤‘ìš”í•œ ì§ˆë¬¸ì„ ì—°êµ¬í•˜ì˜€ìŒ.
- ê·¸ê°€ ì œì•ˆí•œ ëª¨ë¸ì€ ë‹¤ìŒê³¼ ê°™ìŒ:

$$
\log Y_i = \alpha + \rho S_i + \beta_1 X_i + \beta_2 X_i^2 + e_i
$$
::::

:::: {.column width="50%"}
```{r, eval=T}
library(ggdag)
library(dplyr)
coords <- list(
    x = c(e = 1, x = 2, y = 3, s = 2),
    y = c(e=0, x = -.5, y = 0, s = 0.5)
    )

dag <- dagify(y ~ s,
              y ~ e,
              y ~ x, coords = coords)
dag %>% 
  tidy_dagitty() %>% 
  mutate(linetype = ifelse(name == "e", "dashed", "solid")) %>%
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) + 
  geom_dag_point() + 
  geom_dag_text() + 
  geom_dag_edges(aes(edge_linetype = linetype), show.legend = FALSE) + 
  scale_x_continuous(limits = c(0,4))+
  theme_void()
```
::::
:::

---

## êµìœ¡ê³¼ ìˆ˜ì…ì˜ ê´€ê³„ ë¶„ì„

::: {.columns}
:::: {.column width="50%"}
$$
\log Y_i = \alpha + \rho S_i + \beta_1 X_i + \beta_2 X_i^2 + e_i
$$

- ë¯¼ì„œëŠ” $\rho$ ê°’ì´ ì•½ **0.11**ì´ë¼ëŠ” ê²°ê³¼ë¥¼ ë°œê²¬í•¨.
- ì´ëŠ” **ì¶”ê°€ì ì¸ 1ë…„ì˜ êµìœ¡ì´ ì•½ 11%ì˜ ìˆ˜ì… ì¦ê°€ì™€ ê´€ë ¨**ì´ ìˆìŒì„ ì˜ë¯¸í•¨.
- DAG(ìœ í–¥ ì¸ê³¼ ê·¸ë˜í”„)ë¥¼ ì‚´í´ë³´ë©´, ì´ ëª¨ë¸ì´ ì ì ˆí•œì§€ íŒë‹¨í•  ìˆ˜ ìˆìŒ.
- í•˜ì§€ë§Œ ì´ ëª¨ë¸ì´ ì™œ ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆëŠ”ê°€?
::::

:::: {.column width="50%"}
```{r, eval=T}
library(ggdag)
library(dplyr)
coords <- list(
    x = c(e = 1, x = 2, y = 3, s = 2),
    y = c(e=0, x = -.5, y = 0, s = 0.5)
    )

dag <- dagify(y ~ s,
              y ~ e,
              y ~ x, coords = coords)
dag %>% 
  tidy_dagitty() %>% 
  mutate(linetype = ifelse(name == "e", "dashed", "solid")) %>%
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) + 
  geom_dag_point() + 
  geom_dag_text() + 
  geom_dag_edges(aes(edge_linetype = linetype), show.legend = FALSE) + 
  scale_x_continuous(limits = c(0,4))+
  theme_void()
```
::::
:::

---

## êµìœ¡ê³¼ ìˆ˜ì…ì˜ ê´€ê³„

***ëŠ¥ë ¥ í¸í–¥(Ability Bias)***

::: {.columns}
:::: {.column width="50%"}
- íŠ¹ì • êµìœ¡ ìˆ˜ì¤€ê³¼ ê²½ë ¥ì„ ê°€ì§„ ë‚¨ì„±ë“¤ì˜ ìˆ˜ì…ì„ ë¹„êµí•¨.
- ì´ë¥¼ í†µì œí•œ í›„ì—ë„ ëª¨ë“  ì¡°ê±´ì´ ë™ì¼í•œê°€?
- ì£¼ì–´ì§„ $X$ í•˜ì—ì„œ:
  - ê·¼ë©´ì„±ì´ ë‹¤ë¥¸ ë…¸ë™ìë“¤ì„ ì°¾ì„ ìˆ˜ ìˆëŠ”ê°€?
  - ëŠ¥ë ¥ì´ ë‹¤ë¥¸ ë…¸ë™ìë“¤ì„ ì°¾ì„ ìˆ˜ ìˆëŠ”ê°€?
  - ë…¸ë™ìì˜ ê°€ì¡± ë°°ê²½ì´ ì°¨ì´ê°€ ë‚˜ëŠ”ê°€?
::::

:::: {.column width="50%"}
- ë¬¼ë¡  ê·¸ë ‡ë‹¤. ë”°ë¼ì„œ *ëª¨ë“  ì¡°ê±´ì´ ë™ì¼í•œ ê²ƒì€ ì•„ë‹˜.*
- ì´ëŠ” ë¬¸ì œê°€ ë¨. OLSê°€ ì¼ê´€ë˜ë ¤ë©´ ë‹¤ìŒì˜ ì§êµì„± ê°€ì •ì´ í•„ìš”í•¨:
  $$E[e_i | S_i, X_i] \neq 0$$
- ì´ì œ **ëŠ¥ë ¥(Ability) $A_i$**ë¥¼ ëª…ì‹œì ìœ¼ë¡œ í¬í•¨í•´ë³´ì.
::::
:::

---

## ë¯¼ì„œì˜ ëª¨ë¸ê³¼ ê´€ì°°ë˜ì§€ ì•ŠëŠ” ëŠ¥ë ¥(Unobserved Ability)

::: {.columns}
:::: {.column width="50%"}
- ì‚¬ì‹¤ ìš°ë¦¬ëŠ” *ë‘ ê°œ*ì˜ ê´€ì°°ë˜ì§€ ì•ŠëŠ” ë³€ìˆ˜ë¥¼ ê°€ì§€ê³  ìˆìŒ: $e$ ì™€ $A$.
- ë¬¼ë¡  ì´ë¥¼ êµ¬ë³„í•  ìˆ˜ ì—†ìŒ.
- ë”°ë¼ì„œ ìƒˆë¡œìš´ ê´€ì°°ë˜ì§€ ì•ŠëŠ” ìš”ì¸ì„ ì •ì˜í•¨:
  $$u_i = e_i + A_i$$
::::

:::: {.column width="50%"}
```{r, eval=T}
coords <- list(
    x = c(e_A = 1, x = 2, y = 3, s = 2),
    y = c(e_A =0, x = -.5, y = 0, s = 0.5)
    )

dag <- dagify(y ~ s,
              y ~ e_A,
              s ~ e_A,
              y ~ x,coords = coords)
d = dag %>% 
  tidy_dagitty() %>% 
  dag_label(labels = c("y" = "y","s" = "s","x" = "x","e_A"= "u=e+A")) %>%
  mutate(linetype = ifelse(label == "u=e+A", "dashed", "solid")) %>%
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) + 
  geom_dag_point() + 
  geom_dag_text(aes(label=label)) + 
  geom_dag_edges(aes(edge_linetype = linetype), show.legend = FALSE) + 
  scale_x_continuous(limits = c(0,4))+
  theme_void()
d
```
::::
:::

---

## ë¯¼ì„œì˜ ëª¨ë¸ê³¼ ëŠ¥ë ¥ í¸í–¥ì˜ ì˜í–¥

::: {.columns}
:::: {.column width="50%"}
- ìˆ˜ì‹ìœ¼ë¡œ í‘œí˜„í•˜ë©´:
  $$\log Y_i = \alpha + \rho S_i + \beta_1 X_i + \beta_2 X_i^2 + \underbrace{u_i}_{A_i + e_i}$$
- ë•Œë¡œëŠ” ì´ê²ƒì´ ì¤‘ìš”í•˜ì§€ ì•Šìœ¼ë©° OLSì˜ í¸í–¥ì´ ì‘ì„ ìˆ˜ ìˆìŒ.
- í•˜ì§€ë§Œ ê²½ìš°ì— ë”°ë¼ì„œëŠ” ìƒë‹¹í•œ ì˜í–¥ì„ ë¯¸ì³ ì˜ëª»ëœ ê²°ë¡ ì„ ë‚´ë¦´ ìˆ˜ ìˆìŒ. ì˜ˆì œ ì°¸ê³ .
::::

:::: {.column width="50%"}
```{r, eval=T}
coords <- list(
    x = c(e_A = 1, x = 2, y = 3, s = 2),
    y = c(e_A =0, x = -.5, y = 0, s = 0.5)
    )

dag <- dagify(y ~ s,
              y ~ e_A,
              s ~ e_A,
              y ~ x,coords = coords)
d = dag %>% 
  tidy_dagitty() %>% 
  dag_label(labels = c("y" = "y","s" = "s","x" = "x","e_A"= "u=e+A")) %>%
  mutate(linetype = ifelse(label == "u=e+A", "dashed", "solid")) %>%
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) + 
  geom_dag_point() + 
  geom_dag_text(aes(label=label)) + 
  geom_dag_edges(aes(edge_linetype = linetype), show.legend = FALSE) + 
  scale_x_continuous(limits = c(0,4))+
  theme_void()
d
```
::::
:::

---


## êµìœ¡ê³¼ ìˆ˜ì…ì˜ ê´€ê³„

***ì•µê·¸ë¦¬ìŠ¤íŠ¸ì™€ í¬ë£¨ê±°(1991): ì¶œìƒì¼ì€ ë¬´ì‘ìœ„ì¼ ê²ƒì´ë‹¤!***

::: {.columns}
:::: {.column width="50%"}
- ì•µê·¸ë¦¬ìŠ¤íŠ¸ì™€ í¬ë£¨ê±°(AK91)ëŠ” ëŠ¥ë ¥ í¸í–¥ì„ ë‹¤ë£¨ëŠ” ì˜í–¥ë ¥ ìˆëŠ” ì—°êµ¬ì„.
- ì—°êµ¬ ì•„ì´ë””ì–´:
  1. *í•™ìƒì˜ ì¶œìƒì¼*ì„ ë‚˜íƒ€ë‚´ëŠ” ë„êµ¬ë³€ìˆ˜(IV)ë¥¼ êµ¬ì„±í•¨.
  2. íŠ¹ì • ì»·ì˜¤í”„ ë‚ ì§œ ì´í›„ íƒœì–´ë‚œ ì•„ì´ë“¤ì€ í•™êµë¥¼ ëŠ¦ê²Œ ì‹œì‘í•¨.
- ì˜ˆì‹œ: 2021ë…„ 12ì›” 31ì¼ê¹Œì§€ 6ì„¸ê°€ ëœ ì•„ì´ë“¤ì€ 2021ë…„ 9ì›”ì— 1í•™ë…„ì— ì…í•™í•´ì•¼ í•¨.
::::

:::: {.column width="50%"}
- 2015ë…„ 12ì›” 31ì¼ì— íƒœì–´ë‚œ ê²½ìš°, í•™êµ ì…í•™ ì‹œ ë‚˜ì´ëŠ” **5ë…„ 9ê°œì›”**ì„.
- 2016ë…„ 1ì›” 1ì¼ì— íƒœì–´ë‚œ ê²½ìš°, í•™êµ ì…í•™ ì‹œ ë‚˜ì´ëŠ” **6ë…„ 9ê°œì›”**ì„.
- ê·¸ëŸ¬ë‚˜ **ë²•ì ìœ¼ë¡œ 16ì„¸ê°€ ë˜ë©´ í•™êµë¥¼ ì¤‘í‡´í•  ìˆ˜ ìˆìŒ.**
- ë”°ë¼ì„œ ì¤‘í‡´í•˜ëŠ” ì‚¬ëŒë“¤ ì¤‘ ì¼ë¶€ëŠ” ë” ë§ì€ êµìœ¡ì„ ë°›ì•˜ìŒ.
- AK91ì€ **ì¶œìƒ ë¶„ê¸°(quarter of birth) ë”ë¯¸ ë³€ìˆ˜**ë¥¼ IVë¡œ ì‚¬ìš©í•¨: êµìœ¡ ìˆ˜ì¤€ì— ì˜í–¥ì„ ì£¼ì§€ë§Œ ëŠ¥ë ¥($A$)ê³¼ëŠ” ê´€ë ¨ ì—†ìŒ!
::::
:::

---

## ì¶œìƒì¼ ì„¤ì •

```{r, eval=FALSE}
library(lubridate)
born1 = as.Date("2015-12-31")
born2 = as.Date("2016-01-01")
school1 = as.Date("2021-09-01")
school2 = as.Date("2022-09-01")
```

16ì„¸ ìƒì¼ì— í•™êµë¥¼ ì¤‘í‡´í•˜ë©´ ëª‡ ì¼ ë™ì•ˆ í•™êµì— ë‹¤ë‹ˆëŠ”ê°€?

```{r, eval=FALSE}
dropout1 = born1 %m+% years(16)
dropout2 = born2 %m+% years(16)
(schooldays1 = dropout1 - school1)
(schooldays2 = dropout2 - school2)
```

---

## AK91 IV ì„¤ì •

::: {.columns}
:::: {.column width="50%"}
- *ì¶œìƒ ë¶„ê¸°(quarter of birth)* ë”ë¯¸ ë³€ìˆ˜ $z$: êµìœ¡ ìˆ˜ì¤€ì— ì˜í–¥ì„ ì£¼ì§€ë§Œ ëŠ¥ë ¥($A$)ê³¼ëŠ” ê´€ë ¨ ì—†ìŒ.
- íŠ¹íˆ **4ë¶„ê¸°ì— íƒœì–´ë‚¬ëŠ”ì§€ ì—¬ë¶€**ë¥¼ ê³ ë ¤í•¨.
::::

:::: {.column width="50%"}
```{r, eval=FALSE}
coords <- list(
    x = c(e_A = 1, z = 1, y = 3, s = 2),
    y = c(e_A =0, z = 0.5, y = 0, s = 0.5)
    )

dag <- dagify(y ~ s,
              y ~ e_A,
              s ~ e_A,
              s ~ z,coords = coords)
d = dag %>% 
  tidy_dagitty() %>% 
  dag_label(labels = c("y" = "y","s" = "s","z" = "z","e_A"= "u=e+A")) %>%
  mutate(linetype = ifelse(label == "u=e+A", "dashed", "solid")) %>%
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) + 
  geom_dag_point() + 
  geom_dag_text(aes(label=label)) + 
  geom_dag_edges(aes(edge_linetype = linetype), show.legend = FALSE) + 
  scale_x_continuous(limits = c(0,4))+
  theme_void()
d
```
::::
:::

---

## AK91 ì¶”ì •: 2ë‹¨ê³„ ìµœì†ŒììŠ¹ë²•(2SLS)

AK91ì€ ë„ë¦¬ ì‚¬ìš©ë˜ëŠ” IV ì¶”ì • ë°©ë²•ì¸ **2ë‹¨ê³„ ìµœì†ŒììŠ¹ë²•(2SLS)**ì„ ì†Œê°œí•¨.

1. **1ë‹¨ê³„(First Stage):** ë„êµ¬ë³€ìˆ˜(ì˜ˆ: $z$)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚´ìƒ ë³€ìˆ˜ $s$ë¥¼ ì„¤ëª…í•˜ëŠ” ëª¨ë¸ì„ ì¶”ì •í•¨.
2. **2ë‹¨ê³„(Second Stage):** 1ë‹¨ê³„ ëª¨ë¸ì„ ì´ìš©í•˜ì—¬ ì˜ˆì¸¡ëœ $s$ ê°’ì„ ì‚¬ìš©í•˜ì—¬ $y$ë¥¼ ì¶”ì •í•¨. ì´ë¥¼ í†µí•´ ëŠ¥ë ¥($A$)ì´ $s$ì™€ $y$ ê°„ì˜ ìƒê´€ê´€ê³„ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ì œê±°í•¨.

$$
\text{1ë‹¨ê³„: } s_i = \alpha_0 + \alpha_1 z_i + \eta_i
$$
$$
\text{2ë‹¨ê³„: } y_i = \beta_0 + \beta_1 \hat{s}_i + u_i
$$

***ì¡°ê±´:***

1. IVì˜ **ìœ ì˜ì„±(Relevance):** $\alpha_1 \neq 0$
2. **ë…ë¦½ì„±(Independence):** IV í• ë‹¹ì´ ë¬´ì‘ìœ„ì™€ ìœ ì‚¬í•¨: $E[\eta | z] = 0$
3. **ë°°ì œì„±(Exogeneity):** IVê°€ ê²°ê³¼ ë³€ìˆ˜ $y$ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì´ **ì˜¤ì§** $s$ë¥¼ í†µí•´ì„œë§Œ ë‚˜íƒ€ë‚˜ì•¼ í•¨: $E[u | z] = 0$




# Let's do Angrist and Krueger (1991)! 

---

## ì¶œìƒ ë¶„ê¸°ì™€ ì„ê¸ˆ ë°ì´í„°

***ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìš”ì•½ ì •ë³´ í™•ì¸***

```{r ak-data}
data("ak91", package = "masteringmetrics")
# from the modelsummary package
datasummary_skim(data.frame(ak91),histogram = TRUE)
```


---

## AK91 ë°ì´í„° ë³€í™˜

- `q4` ë”ë¯¸ ë³€ìˆ˜ ìƒì„± (`4ë¶„ê¸°ì— íƒœì–´ë‚¬ë‹¤ë©´ TRUE`)
- ì¶œìƒ ì—°ë„(`yob`) ë° ì¶œìƒ ë¶„ê¸°(`qob`)ë¥¼ ë²”ì£¼í˜• ë³€ìˆ˜ë¡œ ë³€í™˜

```{r, echo=T}
ak91 <- mutate(ak91,
               qob_fct = factor(qob),
               q4 = as.integer(qob == "4"),
               yob_fct = factor(yob))

# ì—°ë„ ë° ë¶„ê¸°ë³„ í‰ê·  ì„ê¸ˆ ë° êµìœ¡ ìˆ˜ì¤€ ê³„ì‚°
ak91_age <- ak91 %>%
  group_by(qob, yob) %>%
  summarise(lnw = mean(lnw), s = mean(s)) %>%
  mutate(q4 = (qob == 4))
```

---

## AK91 ê·¸ë¦¼ 1: 1ë‹¨ê³„ íšŒê·€ ë¶„ì„

ì¶œìƒ ë¶„ê¸°ì— ë”°ë¥¸ êµìœ¡ ìˆ˜ì¤€ ë³€í™”ë¥¼ ì‹œê°í™”í•¨

```{r, echo=T, eval=FALSE, echo=TRUE}
ggplot(ak91_age, aes(x = yob + (qob - 1) / 4, y = s )) +
  geom_line() + 
  geom_label(mapping = aes(label = qob, color = q4)) +
  guides(label = FALSE, color = FALSE) +
  scale_x_continuous("Year of birth", breaks = 1930:1940) +
  scale_y_continuous("Years of Education", breaks = seq(12.2, 13.2, by = 0.2),
                     limits = c(12.2, 13.2)) +
  theme_bw()
```

---

## AK91 ê·¸ë¦¼ 1: 1ë‹¨ê³„ íšŒê·€ ë¶„ì„

::: {.columns}
:::: {.column width="50%"}
1. ìˆ«ìëŠ” ì¶œìƒ ë¶„ê¸°ë³„ í‰ê·  êµìœ¡ ì—°ìˆ˜ë¥¼ ë‚˜íƒ€ëƒ„.
2. 4ë¶„ê¸° ì¶œìƒìëŠ” ëŒ€ë¶€ë¶„ ë” ë§ì€ êµìœ¡ì„ ë°›ì•˜ìŒ.
3. ì „ë°˜ì ìœ¼ë¡œ êµìœ¡ ìˆ˜ì¤€ì€ ì¦ê°€í•˜ëŠ” ê²½í–¥ì´ ìˆìŒ.
::::

:::: {.column width="50%"}
```{r ak91-dummy, eval=TRUE, echo=FALSE, fig.height=5}
ggplot(ak91_age, aes(x = yob + (qob - 1) / 4, y = lnw)) +
  geom_line() +
  geom_label(mapping = aes(label = qob, color = q4)) +
  scale_x_continuous("Year of birth", breaks = 1930:1940) +
  scale_y_continuous("Log weekly wages") +
  guides(label = FALSE, color = FALSE) +  
  theme_bw()
```
::::
:::

---

## AK91 ê·¸ë¦¼ 2: ë„êµ¬ë³€ìˆ˜(IV)ê°€ ê²°ê³¼ ë³€ìˆ˜ì— ë¯¸ì¹˜ëŠ” ì˜í–¥

ì¶œìƒ ë¶„ê¸°ë³„ ì„ê¸ˆ ë³€í™”ë¥¼ ì‚´í´ë³´ì.

```{r, echo=T, eval=FALSE}
ggplot(ak91_age, aes(x = yob + (qob - 1) / 4, y = lnw)) +
  geom_line() +
  geom_label(mapping = aes(label = qob, color = q4)) +
  scale_x_continuous("Year of birth", breaks = 1930:1940) +
  scale_y_continuous("Log weekly wages") +
  guides(label = FALSE, color = FALSE) +  
  theme_bw()
```

---

## AK91 ê·¸ë¦¼ 2: ë„êµ¬ë³€ìˆ˜(IV)ê°€ ê²°ê³¼ ë³€ìˆ˜ì— ë¯¸ì¹˜ëŠ” ì˜í–¥

::: {.columns}
:::: {.column width="50%"}
1. 4ë¶„ê¸° ì¶œìƒìê°€ ì „ë°˜ì ìœ¼ë¡œ ë” ë†’ì€ ì„ê¸ˆì„ ë°›ìŒ.
2. ì „ì²´ì ìœ¼ë¡œ ì‹œê°„ì´ ì§€ë‚˜ë©´ì„œ ì£¼ê°„ ì„ê¸ˆì´ ë‹¤ì†Œ ê°ì†Œí•˜ëŠ” ê²½í–¥ì´ ìˆìŒ.
::::

:::: {.column width="50%"}
```{r ak91-wage, echo=FALSE, fig.height=5}
ggplot(ak91_age, aes(x = yob + (qob - 1) / 4, y = lnw)) +
  geom_line() +
  geom_label(mapping = aes(label = qob, color = q4)) +
  scale_x_continuous("ì¶œìƒ ì—°ë„", breaks = 1930:1940) +
  scale_y_continuous("ì£¼ê°„ ì„ê¸ˆ ë¡œê·¸ê°’") +
  guides(label = FALSE, color = FALSE) +  
  theme_bw()
```
::::
:::

---

## Rì—ì„œ IV ì¶”ì • ì‹¤í–‰í•˜ê¸°

::: {.columns}
:::: {.column width="50%"}
- ì—¬ëŸ¬ ê°€ì§€ ì˜µì…˜ì´ ìˆìŒ (`R`ì˜ íŠ¹ì§•! ğŸ˜‰)
- `estimatr` íŒ¨í‚¤ì§€ì˜ [`iv_robust`](https://declaredesign.org/r/estimatr/reference/iv_robust.html) í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•  ê²ƒì„.
- ***Robust***? ì´ í•¨ìˆ˜ëŠ” ì´ë¶„ì‚°ì„±(heteroskedasticity)ì„ ê³ ë ¤í•˜ì—¬ í‘œì¤€ ì˜¤ì°¨ë¥¼ ê³„ì‚°í•¨. [ìì„¸í•œ ì„¤ëª…](https://declaredesign.org/r/estimatr/articles/mathematical-notes.html).
- `predict`ë¥¼ ì‚¬ìš©í•˜ì—¬ $Ì‚{s}$ ê°’ì„ ì–»ëŠ” ê²ƒì— ì£¼ëª©í•´ì•¼ í•¨.
::::

:::: {.column width="50%"}
```{r, echo=T,  `code-line-numbers`="|11"}
library(estimatr)
# ëª¨ë¸ ë¦¬ìŠ¤íŠ¸ ìƒì„±
mod <- list()

# í‘œì¤€ (í¸í–¥ëœ) OLS
mod$ols <- lm(lnw ~ s, data = ak91)

# IV: ì¶œìƒ ë¶„ê¸°ê°€ 4ë¶„ê¸°ì¸ê°€?
# 2ë‹¨ê³„ ë°©ì‹ìœ¼ë¡œ IV ìˆ˜í–‰
mod[["1. stage"]] <- lm(s ~ q4, data = ak91)
ak91$shat         <- predict(mod[["1. stage"]])  
mod[["2. stage"]] <- lm(lnw ~ shat, data = ak91)

# 2SLS ì‹¤í–‰
# IVë¥¼ í•œ ë²ˆì— ìˆ˜í–‰
# ê³µì‹: y ~ x | z
mod$`2SLS`  <- iv_robust(lnw ~ s | q4,
                         data = ak91,
                         diagnostics = TRUE)
```
::::
:::

---

## AK91 ê²°ê³¼ í…Œì´ë¸”

::: {.columns}
:::: {.column width="65%"}
```{r ms1,echo = FALSE}
glance_custom.iv_robust <- function(x){
  f = x$diagnostic_first_stage_fstatistic
  if (is.null(f)) {
    return()
  } else {
    out <- tibble::tibble(`1. Stage F:` = f["value"])
    return(out)
  }
}
library(huxtable)
tab = msummary(models = mod,
                       stars = TRUE,
                       statistic = 'std.error',
                       gof_omit = 'DF|Deviance|AIC|BIC|R2 Adj.|p.value|F$|se_type|statistic|Log.Lik.|Num.Obs.|N',
               output = "huxtable"
         )
tab %>%
  set_bottom_border(row = 9, col = everywhere) %>%
  set_tb_padding(3.5)
```
::::

:::: {.column width="35%"}
1. OLSëŠ” ì¸¡ì • ì˜¤ë¥˜ë¡œ ì¸í•´ í¸í–¥ë  ê°€ëŠ¥ì„±ì´ ìˆìŒ.
2. 1ë‹¨ê³„: IV `q4`ëŠ” í†µê³„ì ìœ¼ë¡œ ìœ ì˜í•˜ë‚˜ íš¨ê³¼ëŠ” ì‘ìŒ (4ë¶„ê¸°ì— íƒœì–´ë‚œ ê²½ìš° êµìœ¡ ì—°ìˆ˜ 0.092 ì¦ê°€). $R^2$ëŠ” 0%ì§€ë§Œ, F-í†µê³„ëŸ‰ì€ í¼.
3. 2ë‹¨ê³„ì˜ ì¶”ì •ì¹˜ëŠ” `2SLS`ì™€ ë™ì¼í•˜ì§€ë§Œ í‘œì¤€ ì˜¤ì°¨ê°€ ë‹¤ë¦„ (2ë‹¨ê³„ ê²°ê³¼ì˜ í‘œì¤€ ì˜¤ì°¨ëŠ” ì˜ëª»ë¨).
::::
:::

---

## F-í†µê³„ëŸ‰

- ì œí•œëœ ëª¨ë¸ê³¼ ì œí•œë˜ì§€ ì•Šì€ ëª¨ë¸ì„ ë¹„êµí•˜ëŠ” ë° ìœ ìš©í•¨.

- ì—¬ê¸°ì„œëŠ” ë„êµ¬ ë³€ìˆ˜ê°€ *ê³µë™ìœ¼ë¡œ* ìœ ì˜ë¯¸í•œì§€ í™•ì¸í•˜ëŠ” ê²ƒì´ í•µì‹¬.

- IVê°€ ê±°ì˜ ì˜ˆì¸¡ë ¥ì„ ê°€ì§€ì§€ ëª»í•˜ë©´, F-í†µê³„ëŸ‰ì´ ë‚®ì•„ì§€ê³  ê·€ë¬´ê°€ì„¤ì„ ê¸°ê°í•  ìˆ˜ ì—†ìŒ. ğŸ˜

---

## ì¶”ê°€ ì œì–´ ë³€ìˆ˜

- êµìœ¡ ìˆ˜ì¤€ì—ì„œ ëª…í™•í•œ ì‹œê°„ì  ê²½í–¥ì´ ê´€ì°°ë¨.

- ì„ê¸ˆë„ ê²½ê¸° ë³€ë™ì˜ ì˜í–¥ì„ ë°›ì„ ê°€ëŠ¥ì„±ì´ ìˆìŒ.

- ì—°ë„ íš¨ê³¼ë¥¼ í†µì œí•´ì•¼ í•¨.

- ì—¬ëŸ¬ ê°œì˜ IVë¥¼ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŒ.

---

## ì¶”ê°€ ì œì–´ ë³€ìˆ˜ ë°˜ì˜í•œ ì¶”ì •

```{r, echo=T}
# we keep adding to our `mod` list:
mod$ols_yr  <- update(mod$ols, . ~ . + yob_fct)  #  previous OLS model
# add exogenous vars on both sides of the `|` !
mod[["2SLS_yr"]] <- estimatr::iv_robust(lnw ~ s  + yob_fct | q4 + yob_fct, data = ak91, diagnostics = TRUE )  
# use all quarters as IVs
mod[["2SLS_all"]] <- estimatr::iv_robust(lnw ~ s  + yob_fct | qob_fct + yob_fct, data = ak91, diagnostics = TRUE  )
```


```{r,echo = FALSE}
# here is how to make the table:
rows <- data.frame(term = c("Instruments","Year of birth"),
                   ols  = c("none","no"),
                   SLS  = c("Q4","no"),
                   ols_yr  = c("none","yes"),
                   SLS_yr  = c("Q4","yes"),
                   SLS_all  = c("All Quarters","yes")
                   )
names(rows)[c(3,5,6)] <- c("2SLS","2SLS_yr","2SLS_all")
tab1 = msummary(models = mod[c("ols","2SLS","ols_yr","2SLS_yr","2SLS_all")], 
                       statistic = 'std.error',
                       gof_omit = 'DF|Deviance|AIC|BIC|R2 Adj.|p.value|F$|se_type|statistic|Log.Lik.|Num.Obs.|N',
               add_rows = rows,
               fmt = 2,
               stars = TRUE,
               coef_omit = 'yob_fct',
               output = 'huxtable')

tab2 = msummary(models = mod[c("ols","2SLS","ols_yr","2SLS_yr","2SLS_all")], 
                       statistic = 'std.error',
                       gof_omit = 'DF|Deviance|AIC|BIC|R2 Adj.|p.value|F$|1. Stage F:|se_type|statistic|Log.Lik.|Num.Obs.|N',
               add_rows = rows,
               fmt = 2,
               stars = TRUE,
               coef_omit = 'yob_fct',
               output = 'huxtable')

htab = tab %>%
  set_bottom_border(row = 6, col = everywhere) %>%
  set_bold(1, everywhere) %>%
  set_tb_padding(4)

htab2 = tab2 %>%
  set_bottom_border(row = 6, col = everywhere) %>%
  set_bold(1, everywhere) %>%
  set_tb_padding(4)

htab
```

---

## ì¶”ê°€ ì œì–´ ë³€ìˆ˜ ë°˜ì˜í•œ ê²°ê³¼

::: {.columns}
:::: {.column width="65%"}
```{r,echo = FALSE}
htab2
```
::::

:::: {.column width="35%"}
**ì—°ë„ í†µì œ ì¶”ê°€**...
- OLS ì¶”ì •ì¹˜ëŠ” ê±°ì˜ ë³€í™” ì—†ìŒ
- 2SLS ì¶”ì •ì¹˜ëŠ” ì†Œí­ ì¦ê°€

**ëª¨ë“  ë¶„ê¸°ë¥¼ IVë¡œ ì‚¬ìš©**...
- 2SLS ì¶”ì •ì¹˜ì˜ ì •ë°€ì„±ì´ í¬ê²Œ í–¥ìƒë¨
- ì¶”ì •ëœ ê³„ìˆ˜ëŠ” ì´ì œ 10.5%!
::::
:::

---


## AK91: ì¶œìƒ ë¶„ê¸°ë¥¼ ì´ìš©í•œ ë„êµ¬ ë³€ìˆ˜ (QOB IV)

::: {.columns}
:::: {.column width="50%"}

- ì¼ê´€ëœ ì¶”ì •ì¹˜ë¥¼ ì–»ìœ¼ë ¤ë©´ ë‹¤ìŒ ì¡°ê±´ì´ ì¶©ì¡±ë˜ì–´ì•¼ í•¨:
  1. IVê°€ ë‚´ìƒì  ë³€ìˆ˜ì˜ ì˜ˆì¸¡ë ¥ì´ ë†’ì•„ì•¼ í•¨.
  2. IVê°€ ë¬´ì‘ìœ„ì ìœ¼ë¡œ í• ë‹¹ë˜ì—ˆê±°ë‚˜ ëˆ„ë½ëœ ë³€ìˆ˜ì™€ ë…ë¦½ì ì´ì–´ì•¼ í•¨.
  3. IVê°€ êµìœ¡ì„ í†µí•´ì„œë§Œ ê²°ê³¼ ë³€ìˆ˜ì— ì˜í–¥ì„ ë¯¸ì³ì•¼ í•¨.

- ì¶œìƒ ë¶„ê¸°(QOB)ëŠ” ì´ëŸ¬í•œ ì¡°ê±´ì„ ì¶©ì¡±í•˜ëŠ”ê°€?

::::

:::: {.column width="50%"}

1. **ê´€ë ¨ì„±**: 1ë‹¨ê³„ ê·¸ë¦¼ê³¼ ë†’ì€ F-í†µê³„ëŸ‰ì€ ê°•í•œ ê´€ë ¨ì„±ì„ ë³´ì—¬ì¤Œ âœ…
2. **ë…ë¦½ì„±**: ì¶œìƒ ë¶„ê¸°ëŠ” *ëª¨ì„± íŠ¹ì„±*ê³¼ ë¬´ê´€í•œê°€? ì¶œìƒì¼ì€ ì™„ì „íˆ ë¬´ì‘ìœ„ì ì´ì§€ ì•ŠìŒ. íŠ¹ì • ì‚¬íšŒê²½ì œì  ë°°ê²½ì—ì„œëŠ” íŠ¹ì • ê³„ì ˆì— ì¶œì‚°í•˜ëŠ” ê²½í–¥ì´ ìˆìŒ. ê·¸ëŸ¬ë‚˜ ìµœìƒìœ„ ëª¨ì„± êµìœ¡ ìˆ˜ì¤€ì€ 2ë¶„ê¸°ì— ì¶œì‚°í•˜ëŠ” ê²½í–¥ì´ ìˆìœ¼ë©°, 4ë¶„ê¸°ê°€ ì•„ë‹˜ âœ…
3. **ë°°ì œ ê°€ëŠ¥ì„±**: 4ë¶„ê¸°ì— íƒœì–´ë‚œ ì•„ì´ë“¤ì´ ì´ˆê¸° í•™ìŠµì—ì„œ ë¶ˆë¦¬í•œ í™˜ê²½ì„ ê²ªê³ , ì¥ê¸°ì ìœ¼ë¡œ ë¶€ì •ì ì¸ ì˜í–¥ì„ ë°›ì„ ê°€ëŠ¥ì„±ì€? ê·¸ë ‡ë‹¤ë©´ $E[u|z] \neq 0$ê°€ ì„±ë¦½í•¨. í•˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” 4ë¶„ê¸° ì¶œìƒìë“¤ì´ ë” ë†’ì€ êµìœ¡ê³¼ ì„ê¸ˆì„ ì–»ìŒ âœ…

::::
:::




# Identification and Inference


---

## IV ì‹ë³„ (Identification)

ì„ í˜• ëª¨í˜•ìœ¼ë¡œ ëŒì•„ê°€ ë³´ì:

$$
y = \beta_0 + \beta_1 x + u
$$

ì—¬ê¸°ì„œ $Cov(x,u) \neq 0$ ì¼ ê²½ìš°, $x$ëŠ” *ë‚´ìƒì * ë³€ìˆ˜ì´ë‹¤.

***IVì˜ ì¡°ê±´***

1. **1ë‹¨ê³„ ì¡°ê±´(ê´€ë ¨ì„±)**: $Cov(z,x) \neq 0$
2. **IV ì™¸ìƒì„± ì¡°ê±´**: $Cov(z,u) = 0$, ì¦‰ IVëŠ” ê²°ê³¼ ë°©ì •ì‹ì—ì„œ ì™¸ìƒì ì´ì–´ì•¼ í•œë‹¤.

---

## ìœ íš¨í•œ ëª¨ë¸(A) vs ìœ íš¨í•˜ì§€ ì•Šì€ ëª¨ë¸(B)

```{r IV-dag2, warning=FALSE, message=FALSE, echo=FALSE, fig.height=3.5}
coords <- list(
    x = c(z = 1, x = 3, u = 4, y = 5),
    y = c(z = 0, x = 0, u = 0.5, y = 0)
)

dag1 <- dagify(y ~ x + u, x ~ z + u, coords = coords)

d1 = dag1 %>% 
  tidy_dagitty() %>% 
  mutate(linetype = ifelse(name == "u", "dashed", "solid")) %>% 
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) + 
  geom_dag_point() + 
  geom_dag_text() + 
  geom_dag_edges(aes(edge_linetype = linetype), show.legend = FALSE) + 
  theme_void()

dag2 <- dagify(y ~ x + u, x ~ z + u, z ~ u, coords = coords)

d2 = dag2 %>% 
  tidy_dagitty() %>% 
  mutate(linetype = ifelse(name == "u", "dashed", "solid")) %>% 
  ggplot(aes(x = x, y = y, xend = xend, yend = yend)) + 
  geom_dag_point() + 
  geom_dag_text() + 
  geom_dag_edges(aes(edge_linetype = linetype), show.legend = FALSE) + 
  theme_void()

cowplot::plot_grid(d1, NULL, d2, nrow=1, rel_widths=c(1, 0.15, 1), labels=c("(A)", "", "(B)"))
```

---

## IV ì‹ë³„ ì¡°ê±´

::: {.columns}
:::: {.column width="50%"}

> ***IVì˜ ì¡°ê±´***
>
> 1. **1ë‹¨ê³„ ì¡°ê±´(ê´€ë ¨ì„±)**: $Cov(z,x) \neq 0$
> 2. **IV ì™¸ìƒì„± ì¡°ê±´**: $Cov(z,u) = 0$

::::

:::: {.column width="50%"}

- ì´ëŸ¬í•œ ì¡°ê±´ì´ ì–´ë–»ê²Œ $\beta_1$ì„ ì‹ë³„í•˜ëŠ”ê°€?
- (ì´ë¡ ì ìœ¼ë¡œ $\beta_1$ì„ íŠ¹ì •í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì€?)

::::
:::

---

## IV ì‹ë³„

\begin{align}
Cov(z,y) &= Cov(z, \beta_0 + \beta_1 x + u) \\
         &= \beta_1 Cov(z,x) + Cov(z,u)
\end{align}

::: {.columns}
:::: {.column width="50%"}

- ì¡°ê±´ 2 (**IV ì™¸ìƒì„±**)ì— ë”°ë¼ $Cov(z,u) = 0$ì´ë©´:

$$
Cov(z,y) = \beta_1 Cov(z,x)
$$

::::

:::: {.column width="50%"}

- ì¡°ê±´ 1 (**ê´€ë ¨ì„±**)ì´ ì„±ë¦½í•˜ë©´ $Cov(z,x)\neq0$ ì´ë¯€ë¡œ ë‹¤ìŒê³¼ ê°™ì´ ë‚˜ëˆŒ ìˆ˜ ìˆë‹¤:

$$
\beta_1 = \frac{Cov(z,y)}{Cov(z,x)}.
$$

- ë”°ë¼ì„œ $\beta_1$ì€ *ì‹ë³„ ê°€ëŠ¥*í•˜ë©°, í‘œë³¸ ê³µì‹ì„ ì´ìš©í•´ ì¶”ì •í•  ìˆ˜ ìˆë‹¤.

::::
:::

---

## IV ì¶”ì •ëŸ‰

í‘œë³¸ ê³µì‹ì„ ì ìš©í•˜ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤:

$$\hat{\beta}_1 = \frac{\sum_{i=1}^n (z_i - \bar{z})(y_i - \bar{y})}{\sum_{i=1}^n (z_i - \bar{z})(x_i - \bar{x})}$$

- ì ˆí¸ ì¶”ì •ì¹˜ëŠ” $\hat{\beta}_0 = \bar{y} - \hat{\beta}_1 \bar{x}$
- ë§Œì•½ ì¡°ê±´ 1, 2ê°€ ì¶©ì¡±ëœë‹¤ë©´, **IV ì¶”ì •ëŸ‰ì€ ì¼ì¹˜ ì¶”ì •ëŸ‰ì´ ëœë‹¤**:

$$
\text{plim}(\hat{\beta}_1) = \beta_1
$$

ì´ ê²½ìš°, **ì¼ê´€ì„±ì„ ê°€ì§„ ì¶”ì •ëŸ‰(consistent estimator)**ì´ë¼ê³  í•œë‹¤.

---

## IV ì¶”ì •ëŸ‰ì˜ ë¶„ì‚°

$E(u^2|z) = \sigma^2$ ê°€ì • í•˜ì—:

$$Var(\hat{\beta}_{1,IV}) = \frac{\sigma^2}{n \sigma_x^2 \rho_{x,z}^2}$$

- $\sigma_x^2$: $x$ì˜ ë¶„ì‚°
- $\sigma^2$: $u$ì˜ ë¶„ì‚°
- $\rho_{x,z}$: $x$ì™€ $z$ì˜ ìƒê´€ê³„ìˆ˜

ë‘ ê°€ì§€ ì‚¬ì‹¤ì„ ì‰½ê²Œ ê´€ì°° í•  ìˆ˜ ìˆë‹¤.

- $\rho_{x,z}$ê°€ ì—†ìœ¼ë©´ OLS ë¶„ì‚°ê³¼ ë™ì¼
- nì´ ì¦ê°€í•˜ë©´ ë¶„ì‚°ì´ ê°ì†Œ


---

## IVì˜ ë¶„ì‚°ì´ OLSë³´ë‹¤ í•­ìƒ í¼

$\rho_{x,z}$ë¥¼ $R_{x,z}^2$ë¡œ ë°”ê¾¸ë©´:


$$Var(\hat{\beta}_{1,IV}) = \frac{\sigma^2}{n \sigma_x^2 R_{x,z}^2}$$

- $R_{x,z}^2 < 1$ ì´ë¯€ë¡œ, ì¼ë°˜ì ìœ¼ë¡œ $Var(\hat{\beta}_{1,IV}) > Var(\hat{\beta}_{1,OLS})$ì„.
- $R_{x,z}^2 = 1$ì´ë©´ OLSì™€ ë™ì¼í•´ì§. ì¦‰, $z = x$ì´ë©´ IVëŠ” ë¶ˆí•„ìš”í•¨.

ë”°ë¼ì„œ ì™¸ìƒë³€ìˆ˜ xê°€ ìˆìœ¼ë©´ êµ³ì´ zë¥¼ í†µí•´ IV ì¶”ì •ì„ í•  í•„ìš”ê°€ ì—†ë‹¤. 

---

## êµìœ¡ì´ ì—¬ì„± ì„ê¸ˆì— ë¯¸ì¹˜ëŠ” ì˜í–¥

$$
\log wage = \beta_0 + \beta_1 educ + u
$$

OLSì™€ IV(ë¶€ì¹œ í•™ë ¥ ì‚¬ìš©) ë¹„êµ:

```{r mroz1, echo=TRUE}
data(mroz, package = "wooldridge")
mods = list()
mods$OLS <- lm(lwage ~ educ, data = mroz)
mods[['First Stage']] <- lm(educ ~ fatheduc, data = subset(mroz, inlf == 1))
mods$IV  <- estimatr::iv_robust(lwage ~ educ | fatheduc, data = mroz)
```

```{r, echo=FALSE}
modelsummary::modelsummary(mods, output="huxtable")
```

---

# IV Standard Errors

```{r se-plot,echo = FALSE,fig.height=5}
coefs_ols = broom::tidy(mods$OLS, conf.int = TRUE)
coefs_IV = broom::tidy(mods$IV, conf.int = TRUE)

bind_rows(
  coefs_ols %>% filter(term == "educ") %>% mutate(estimator = "OLS"),
  coefs_IV %>% filter(term == "educ") %>% mutate(estimator = "IV")
  ) %>%
  ggplot(aes(x=estimator, y=estimate, ymin=conf.low, ymax=conf.high)) +
  geom_hline(yintercept = 0.0, color = "red", size =1.5) +
  geom_pointrange() +
  theme_bw()
```


---

## ì•½í•œ ë„êµ¬ ë³€ìˆ˜ (Weak IV) ë¬¸ì œ

IV ì¶”ì •ì¹˜ëŠ” consistentí•˜ë‹¤



ì•½í•œ IVì˜ ê²½ìš° ì¼ì¹˜ì„±ì´ ë³´ì¥ë˜ì§€ ì•ŠìŒ:

$$
\text{plim}(\hat{\beta}_{1,IV}) = \beta_1 + \frac{Cor(z,u)}{Cor(z,x)} \cdot \frac{\sigma_u}{\sigma_x}
$$

- ì•½í•œ IVëŠ” $Cor(z,x)$ ê°’ì´ ì‘ì€ ê²½ìš°ë¥¼ ì˜ë¯¸í•¨.
- $Cor(z,x)$ê°€ ì‘ìœ¼ë©´ ì¼ì¹˜ì„±ì´ ê¹¨ì§ˆ ê°€ëŠ¥ì„±ì´ ë†’ìŒ.
- nì´ í¬ë”ë¼ë„ ì‹¤ì œ ëª¨ì§‘ë‹¨ì˜ $\beta_1$ìœ¼ë¡œ ìˆ˜ë µí•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ.



---

## ì•½í•œ ë„êµ¬ ë³€ìˆ˜ (Weak IV)

- ì„ì‚°ë¶€ê°€ í•˜ë£¨ì— í”¼ìš´ ë‹´ë°° ê°‘ ìˆ˜(*packs*)ê°€ ì•„ê¸°ì˜ ì¶œìƒ ì²´ì¤‘(*bwght*)ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ì‚´í´ë³´ì:

$$
\log(bwght) = \beta_0 + \beta_1 packs + u
$$

- ìš°ë¦¬ëŠ” í¡ì—° í–‰ë™ì´ ê±´ê°• ê´€ë ¨ ë³€ìˆ˜ë“¤ê³¼ ìƒê´€ê´€ê³„ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìœ¼ë©°, ì´ëŸ¬í•œ ë³€ìˆ˜ë“¤ì´ $u$ì— í¬í•¨ë˜ì–´ ì¶œìƒ ì²´ì¤‘ì— ì˜í–¥ì„ ë¯¸ì¹  ê°€ëŠ¥ì„±ì´ ìˆë‹¤ê³  ìš°ë ¤í•œë‹¤. ë”°ë¼ì„œ ì ì ˆí•œ ë„êµ¬ ë³€ìˆ˜ë¥¼ ì°¾ì•„ì•¼ í•œë‹¤. 

- ë‹´ë°° ê°€ê²©(*cigprice*)ì„ IVë¡œ ì‚¬ìš©í•œë‹¤ê³  ê°€ì •í•˜ì. ì´ëŠ” ë‹´ë°° ê°€ê²©ì´ $u$ì— í¬í•¨ëœ ìš”ì¸ë“¤ê³¼ ë¬´ìƒê´€í•˜ë‹¤ëŠ” ê°€ì •í•˜ì— ê°€ëŠ¥í•˜ë‹¤. ë¨¼ì € *cigprice*ê°€ *packs*ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ 1ë‹¨ê³„ íšŒê·€ë¶„ì„ì„ í†µí•´ í™•ì¸í•œ í›„, 2ë‹¨ê³„ ìµœì†ŒììŠ¹ë²•(2SLS) ì¶”ì • ê²°ê³¼ë¥¼ ì‚´í´ë³´ì.


---


## ì•½í•œ ë„êµ¬ ë³€ìˆ˜ (Weak IV)


```{r bw, echo=TRUE}
data(bwght, package = "wooldridge")
mods <- list()
mods[["First Stage"]] <- lm(packs ~ cigprice, data = bwght)
mods[["IV"]] <- estimatr::iv_robust(log(bwght) ~  packs | cigprice, data = bwght, diagnostics = TRUE)
```

```{r,echo = FALSE}
modelsummary(mods, gof_omit = 'DF|Deviance|AIC|BIC|R2 Adj.|p.value|F$|se_type|statistic|Log.Lik.|Num.Obs.|N|RMSE', output = "huxtable") %>%
  set_bottom_border(row = 7, col = everywhere) %>%
  set_bold(1, everywhere) %>%
  set_tb_padding(5)
```

## ì•½í•œ ë„êµ¬ ë³€ìˆ˜ (Weak IV)

::::columns
:::{.column width="50%"}
* ì²« ë²ˆì§¸ ì—´: ë§¤ìš° ì•½í•œ ì²« ë²ˆì§¸ ë‹¨ê³„. *cigprice*ê°€ *packs*ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì´ ê±°ì˜ ì—†ë‹¤!

* $R^2$ ê°’ì´ 0ì— ê°€ê¹Œì›€.

* ê·¸ë ‡ë‹¤ë©´ ì´ IVë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë©´ ì–´ë–»ê²Œ ë ê¹Œ?
:::

:::{.column width="50%"}

* ë‘ ë²ˆì§¸ ì—´: *packs*ê°€ ì¶œìƒ ì²´ì¤‘ì— ë§¤ìš° í¬ê³ , ì‹¬ì§€ì–´ **ì–‘ì˜** ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ê²ƒìœ¼ë¡œ ë‚˜íƒ€ë‚¨. ğŸ¤”

* í•˜ì§€ë§Œ í‘œì¤€ ì˜¤ì°¨ê°€ ë§¤ìš° í¼.

* $R^2$ ê°’ì´ -23?!

* ì²« ë²ˆì§¸ ë‹¨ê³„ì˜ F-í†µê³„ëŸ‰: 0.121. ì´ëŠ” p-ê°’ì´ `r round(mods[["IV"]]$diagnostic_first_stage_fstatistic["p.value"],3)` ì„ì„ ì˜ë¯¸í•˜ë©°, **ê·€ë¬´ê°€ì„¤(H0): ì²« ë²ˆì§¸ ë‹¨ê³„ì˜ íš¨ê³¼ ì—†ìŒ**ì„ ì „í˜€ ê¸°ê°í•  ìˆ˜ ì—†ìŒ.

* ê²°ë¡ : **ì˜ëª»ëœ ì ‘ê·¼ ë°©ì‹** âŒ
:::
::::



------------------------------------------------------------------------

## ğŸ” ì¸ê³¼ ê´€ê³„ë¥¼ ì°¾ì•„ê°€ëŠ” ê¸¸

âœ… ë°ì´í„°ë¥¼ ì–´ë–»ê²Œ ë‹¤ë£°ê¹Œ?: ì½ê¸°(Read), ì •ë¦¬(Tidy), ì‹œê°í™”(Visualize)...

âœ… ë³€ìˆ˜ê°„ ê´€ê³„ë¥¼ ì–´ë–»ê²Œ ìš”ì•½í• ê¹Œ? ë‹¨ìˆœ / ë‹¤ì¤‘ ì„ í˜• íšŒê·€...ë¹„ì„ í˜•íšŒê·€, êµì°¨ë³€ìˆ˜...

âœ… ì¸ê³¼ ê´€ê³„(Causality)ë€ ë¬´ì—‡ì¸ê°€?

âœ… ì „ì²´ ëª¨ì§‘ë‹¨ì„ ê´€ì¸¡í•˜ì§€ ëª»í•˜ë©´ ì–´ë–»ê²Œ í• ê¹Œ? Sampling!

âœ… ìš°ë¦¬ì˜ ì—°êµ¬ ê²°ê³¼ê°€ ë‹¨ìˆœí•œ ë¬´ì‘ìœ„(Randomness) ë•Œë¬¸ì¼ ìˆ˜ë„ ìˆì„ê¹Œ? ì‹ ë¢°êµ¬ê°„ê³¼ ê°€ì„¤ê²€ì •. í†µê³„ì  ì¶”ë¡ 

ğŸš§ ***ì‹¤ì œë¡œ ì™¸ìƒì„±ì„ ì–´ë–»ê²Œ ì°¾ì•„ë‚¼ ìˆ˜ ìˆì„ê¹Œ?***: ì´ì¤‘ ì°¨ë¶„, íšŒê·€ ë¶ˆì—°ì† ì„¤ê³„, ë„êµ¬ ë³€ìˆ˜

------------------------------------------------------------------------


<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">

::: {style="display: flex; justify-content: center; align-items: center; height: 70vh;"}
<h2 style="color: #ff6666; text-align: center; font-family: &#39;Pacifico&#39;, cursive; font-size: 50px;">

THE END!

</h2>
:::
